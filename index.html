<script>
    var w = 2048;
    var h = 2048;
    var bounds = [[0, 0], [h, w]];

    var map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxBounds: bounds,
        maxBoundsViscosity: 1.0
    });

    // Harita resimlerinin listesi
    var mapImages = [
        'resimler/Harita.png',    // index 0
        'resimler/THarita1.png', // index 1
        'resimler/THarita2.png', // index 2
        'resimler/THarita3.png', // index 3
        'resimler/THarita4.png'  // index 4
    ];
    
    // Harita Açıklama Metinleri
    var mapDescriptions = [
        "Standart coğrafya haritası. Bu, dünyanın günümüzdeki genel görünümüdür.", // Ana Harita
        "Hikâyenin geçtiği yer, dumanlar içindeki bu dünyadır. Büyüklüğü Almanya kadardır.", // Harita 1
        "Şu anda tamamen dumanın altında kalmış durumdadır.", // Harita 2
        "Hikâyenin geçtiği yerin batısında, büyük kulak memelerine sahip bir halk olan Tana kabilesinin (Tana soyunun) yurdu bulunur. Burada kıtanın altın çağını kurmuşlardır.", // Harita 3
        "Görkemli (en parlak) dönemlerindeki toprakları / en geniş sınırları." // Harita 4
    ];
    
    // Harita Başlıkları (map-info kutusu için)
    var mapTitles = [
        "Ana Harita",
        "Toshokan Medeniyetleri (1)",
        "Toshokan Medeniyetleri (2)",
        "Toshokan Medeniyetleri (3)",
        "Toshokan Medeniyetleri (4)"
    ];
    
    var mapLayers = [];
    var currentActiveMap = null;

    var mapInfoContainer = document.getElementById('map-info');
    var infoTitle = mapInfoContainer.querySelector('h4');
    var infoText = document.getElementById('info-text');


    // --- TÜM HARİTALARI ARKA PLANDA OLUŞTUR VE İNDİR ---
    mapImages.forEach((url, index) => {
        var layer = L.imageOverlay(url, bounds);
        mapLayers.push(layer);
        
        if (index === 0) {
            layer.addTo(map);
            currentActiveMap = layer;
        }    
    });

    map.setView([h / 2, w / 2], -1.25);

    var Isaret = L.icon({
        iconUrl: 'resimler/Isaret2.png',
        iconSize: [48, 48],
        iconAnchor: [24, 48],
        popupAnchor: [0, -32]
    });

    // --- POPUP İÇERİKLERİ VE KONUMLAR (DÜZENLENDİ) ---
    
    // 1. HYDİAH (Önceki 'centerMarker')
    var hydiahContent = "<h3>HYDİAH TOPRAKLARI</h3><p>Hydiah ırkından Istayu halkının yuvası olan bu bölge... <a href='...'>Devamı</a></p><img src='resimler/Hydiah.png' alt='...'>";
    var hydiahMarker = L.marker([1365, 458], {icon: Isaret}).bindPopup(hydiahContent, { className: 'custom-popup' });
    
    // 2. SİSSİZ ALAN (Önceki 'northWestLocation')
    var sissizContent = "<h3>Sissiz Alan</h3><p>Acıpelin Gizmeni felaketi sonrası geriye kalan yaşanabilir bölge, boyutu günümüz Almanyası kadardır.</p><img src='resimler/SAHarita.png' alt='...'>";    
    var sissizMarker = L.marker([1098, 659], {icon: Isaret}).bindPopup(sissizContent, { className: 'custom-popup' });

    // 3. LOBIN (YENİ EKLENEN, Koordinat: Y:490, X:1656)
    var lobinContent = "<h3>LOBİN TOPRAKLARI</h3><p>İnsanın atası olan Lobino kemir-genine ev sahipliği yapar. Tektonik... <a href='...'>Devamı</a></p><img src='resimler/Lobin.png' alt='...'>";
    var lobinMarker = L.marker([490, 1656], {icon: Isaret}).bindPopup(lobinContent, { className: 'custom-popup' });
    
    // *******************************************************************
    // locationsLayer'a tüm işaretçiler eklendi ve eski değişkenler silindi
    // *******************************************************************
    var sisUrl = 'resimler/Bulutlar.png';
    var sisBounds = [[0, 0], [h, w]];    
    var sisLayer = L.imageOverlay(sisUrl, sisBounds, { opacity: 0.8, interactive: false });
    
    // Artık 3 işaretçimiz var: hydiahMarker, sissizMarker ve lobinMarker
    var locationsLayer = L.layerGroup([hydiahMarker, sissizMarker, lobinMarker]);

    // "Toshokan Medeniyetleri" için boş bir katman
    var toshokanLayer = L.layerGroup();

    var overlayMaps = {
        "Konumlar": locationsLayer,
        "Sisi Göster": sisLayer,
        "Toshokan Medeniyetleri": toshokanLayer
    };

    var control = L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);
    locationsLayer.addTo(map);
    
    
    // --- BUTON VE KONTROL MANTIĞI ---

    var buttonContainer = document.getElementById('button-container');
    var controlContainer = control.getContainer();
    var inputs = controlContainer.getElementsByTagName('input');
    
    var konumlarInput = inputs[0];    
    var sisInput = inputs[1];      

    // HARİTA DEĞİŞTİRME FONKSİYONU (Açıklamayı da günceller)
    function switchMap(index) {
        var newLayer = mapLayers[index];
        
        if (newLayer === currentActiveMap) {
            return;
        }
        
        if (currentActiveMap) {
            map.removeLayer(currentActiveMap);
        }
        
        newLayer.addTo(map);
        currentActiveMap = newLayer;
        
        // Açıklama kutusunu güncelle
        infoTitle.textContent = mapTitles[index];
        infoText.textContent = mapDescriptions[index];
    }

    // Butonlara tek bir olay dinleyicisi ekle
    buttonContainer.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') {
            var index = parseInt(e.target.dataset.mapIndex, 10);
            switchMap(index);
        }
    });


    // Haritaya bir katman EKLENDİĞİNDE tetiklenir
    map.on('overlayadd', function(e) {
        if (e.layer === toshokanLayer) {
            // Butonları ve Harita Bilgi Kutusunu Göster
            buttonContainer.style.display = 'block';
            mapInfoContainer.style.display = 'block';
            
            // Diğer katmanları haritadan kaldır ve tikleri kaldır    
            map.removeLayer(locationsLayer);
            map.removeLayer(sisLayer);
            konumlarInput.checked = false;
            sisInput.checked = false;
            
            // Seçenekleri devre dışı bırak
            konumlarInput.disabled = true;
            sisInput.disabled = true;
            
            // İlk tematik haritaya (index 1) geç ve bilgisini göster
            switchMap(1);    
        }
    });

    // Haritadan bir katman KALDIRILDIĞINDA tetiklenir
    map.on('overlayremove', function(e) {
        if (e.layer === toshokanLayer) {
            // Butonları ve Harita Bilgi Kutusunu Gizle
            buttonContainer.style.display = 'none';
            mapInfoContainer.style.display = 'none';
            
            konumlarInput.disabled = false;
            sisInput.disabled = false;
            
            // Orijinal haritaya geri dön    
            switchMap(0);
        }
    });

</script>
